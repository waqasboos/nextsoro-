<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nextsoro Admin</title>
    <link rel="stylesheet" href="admin.css">
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-screen">
        <div class="login-container">
            <h1>Nextsoro Admin</h1>
            <p>Enter your password to access the admin panel</p>
            <input type="password" id="admin-password" placeholder="Admin Password">
            <button id="login-btn">Login</button>
            <p id="login-error" class="error-message"></p>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="admin-panel" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Nextsoro Admin</h2>
            </div>
            <ul class="sidebar-nav">
                <li><a href="#" class="nav-link active" data-section="dashboard">Dashboard</a></li>
                <li><a href="#" class="nav-link" data-section="add-product">Add Product</a></li>
                <li><a href="#" class="nav-link" data-section="edit-products">Edit Products</a></li>
                <li><a href="#" class="nav-link" data-section="settings">Settings</a></li>
                <li><a href="#" class="nav-link" data-section="import-export">Import/Export</a></li>
                <li><a href="#" id="logout-btn" class="nav-link">Logout</a></li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <h1>Dashboard</h1>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Products</h3>
                        <p id="total-products">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Categories</h3>
                        <p id="total-categories">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Data Backend</h3>
                        <p id="data-backend">Firebase</p>
                    </div>
                </div>
                <div class="recent-products">
                    <h2>Recent Products</h2>
                    <div id="recent-products-list" class="products-list">
                        <!-- Recent products will be populated here -->
                    </div>
                </div>
            </section>

            <!-- Add Product Section -->
            <section id="add-product" class="content-section">
                <h1>Add New Product</h1>
                <form id="add-product-form" class="product-form">
                    <div class="form-group">
                        <label for="product-title">Product Title *</label>
                        <input type="text" id="product-title" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="product-short-desc">Short Description *</label>
                        <textarea id="product-short-desc" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="product-full-desc">Full Description</label>
                        <textarea id="product-full-desc" rows="5"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="product-price">Price *</label>
                            <input type="number" id="product-price" step="0.01" min="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="product-category">Category *</label>
                            <input type="text" id="product-category" list="categories-list" required>
                            <datalist id="categories-list">
                                <!-- Categories will be populated dynamically -->
                            </datalist>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="product-sku">SKU</label>
                            <input type="text" id="product-sku">
                        </div>
                        
                        <div class="form-group">
                            <label for="product-affiliate-link">Affiliate Link *</label>
                            <input type="url" id="product-affiliate-link" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="product-visibility">Visibility</label>
                        <select id="product-visibility">
                            <option value="visible">Visible</option>
                            <option value="hidden">Hidden</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="product-images">Product Images</label>
                        <input type="file" id="product-images" multiple accept="image/*">
                        <div id="image-preview" class="image-preview">
                            <!-- Image previews will be shown here -->
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Add Product</button>
                    <div id="add-product-message" class="form-message"></div>
                </form>
            </section>

            <!-- Edit Products Section -->
            <section id="edit-products" class="content-section">
                <h1>Edit Products</h1>
                <div class="search-bar">
                    <input type="text" id="edit-search" placeholder="Search products...">
                </div>
                <div id="edit-products-list" class="products-list">
                    <!-- Products for editing will be populated here -->
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="content-section">
                <h1>Settings</h1>
                <div class="settings-grid">
                    <div class="setting-card">
                        <h3>Site Information</h3>
                        <form id="site-settings-form">
                            <div class="form-group">
                                <label for="site-name">Site Name</label>
                                <input type="text" id="site-name" value="Nextsoro">
                            </div>
                            <div class="form-group">
                                <label for="admin-password-setting">Admin Password</label>
                                <input type="password" id="admin-password-setting" placeholder="Leave blank to keep current">
                            </div>
                            <button type="submit" class="btn btn-primary">Save Settings</button>
                        </form>
                    </div>
                    
                    <div class="setting-card">
                        <h3>Data Backend</h3>
                        <div class="form-group">
                            <label for="data-backend-select">Select Backend</label>
                            <select id="data-backend-select">
                                <option value="firebase">Firebase Realtime Database</option>
                                <option value="json">JSON + Server API</option>
                            </select>
                        </div>
                        <p class="setting-description">
                            Firebase provides real-time updates. JSON backend requires a server for write operations.
                        </p>
                    </div>
                    
                    <div class="setting-card">
                        <h3>Social Links</h3>
                        <form id="social-links-form">
                            <div class="form-group">
                                <label for="facebook-link">Facebook</label>
                                <input type="url" id="facebook-link" placeholder="https://facebook.com/yourpage">
                            </div>
                            <div class="form-group">
                                <label for="twitter-link">Twitter</label>
                                <input type="url" id="twitter-link" placeholder="https://twitter.com/yourhandle">
                            </div>
                            <div class="form-group">
                                <label for="instagram-link">Instagram</label>
                                <input type="url" id="instagram-link" placeholder="https://instagram.com/yourprofile">
                            </div>
                            <button type="submit" class="btn btn-primary">Save Social Links</button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Import/Export Section -->
            <section id="import-export" class="content-section">
                <h1>Import/Export Products</h1>
                <div class="import-export-grid">
                    <div class="action-card">
                        <h3>Export Products</h3>
                        <p>Download a JSON file with all your current products.</p>
                        <button id="export-btn" class="btn btn-primary">Export to JSON</button>
                    </div>
                    
                    <div class="action-card">
                        <h3>Import Products</h3>
                        <p>Upload a JSON file to import products. This will replace all existing products.</p>
                        <input type="file" id="import-file" accept=".json">
                        <div class="import-options">
                            <label>
                                <input type="radio" name="import-mode" value="replace" checked> Replace All Products
                            </label>
                            <label>
                                <input type="radio" name="import-mode" value="merge"> Merge with Existing
                            </label>
                        </div>
                        <button id="import-btn" class="btn btn-primary" disabled>Import Products</button>
                        <div id="import-message" class="form-message"></div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="edit-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Product</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="edit-product-form" class="product-form">
                    <input type="hidden" id="edit-product-id">
                    
                    <div class="form-group">
                        <label for="edit-product-title">Product Title *</label>
                        <input type="text" id="edit-product-title" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-product-short-desc">Short Description *</label>
                        <textarea id="edit-product-short-desc" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-product-full-desc">Full Description</label>
                        <textarea id="edit-product-full-desc" rows="5"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-product-price">Price *</label>
                            <input type="number" id="edit-product-price" step="0.01" min="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-product-category">Category *</label>
                            <input type="text" id="edit-product-category" list="edit-categories-list" required>
                            <datalist id="edit-categories-list">
                                <!-- Categories will be populated dynamically -->
                            </datalist>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-product-sku">SKU</label>
                            <input type="text" id="edit-product-sku">
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-product-affiliate-link">Affiliate Link *</label>
                            <input type="url" id="edit-product-affiliate-link" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-product-visibility">Visibility</label>
                        <select id="edit-product-visibility">
                            <option value="visible">Visible</option>
                            <option value="hidden">Hidden</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Current Images</label>
                        <div id="current-images" class="current-images">
                            <!-- Current product images will be shown here -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-product-images">Add More Images</label>
                        <input type="file" id="edit-product-images" multiple accept="image/*">
                        <div id="edit-image-preview" class="image-preview">
                            <!-- New image previews will be shown here -->
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Update Product</button>
                        <button type="button" id="delete-product-btn" class="btn btn-danger">Delete Product</button>
                    </div>
                    <div id="edit-product-message" class="form-message"></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getDatabase, ref, push, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

        // Configuration
        const CONFIG = {
            SITE_NAME: "Nextsoro",
            ADMIN_PASSWORD: "Password (@#@$@#%@#%26#2#6#26#%26#&26#&2sdhdddgg32#$%#3#%%#454)",
            THEME_COLORS: {
                primaryBlue: "#2563eb",
                primaryPurple: "#7c3aed"
            },
            // Set to 'firebase' or 'json'
            DATA_BACKEND: "firebase"
        };

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAHG1tWV8kfwYtXtEqGITheHLKX6l7pKBY",
            authDomain: "nextsoro-d51fc.firebaseapp.com",
            databaseURL: "https://nextsoro-d51fc-default-rtdb.firebaseio.com",
            projectId: "nextsoro-d51fc",
            storageBucket: "nextsoro-d51fc.firebasestorage.app",
            messagingSenderId: "313372427225",
            appId: "1:313372427225:web:32463f6f42663cd0978fc8",
            measurementId: "G-QQ6CEW7Q53"
        };

        // Initialize Firebase
        let app, db, storage;
        let products = [];
        let categories = [];
        let isLoggedIn = false;

        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getDatabase(app);
                storage = getStorage(app);
                console.log("Firebase initialized successfully");
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                // Fallback to JSON backend if Firebase fails
                if (CONFIG.DATA_BACKEND === "firebase") {
                    console.log("Falling back to JSON backend");
                    CONFIG.DATA_BACKEND = "json";
                }
            }
        }

        // Admin login
        function adminLogin(password) {
            if (password === CONFIG.ADMIN_PASSWORD) {
                isLoggedIn = true;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'flex';
                loadAdminData();
                return true;
            } else {
                document.getElementById('login-error').textContent = 'Invalid password';
                return false;
            }
        }

        // Load admin data
        function loadAdminData() {
            if (CONFIG.DATA_BACKEND === 'firebase') {
                fetchProductsRealtime();
            } else {
                fetchProductsJSON();
            }
            
            // Update backend indicator
            document.getElementById('data-backend').textContent = CONFIG.DATA_BACKEND === 'firebase' ? 'Firebase' : 'JSON';
            document.getElementById('data-backend-select').value = CONFIG.DATA_BACKEND;
        }

        // Fetch products from Firebase with real-time updates
        function fetchProductsRealtime() {
            if (CONFIG.DATA_BACKEND !== "firebase") return;
            
            const productsRef = ref(db, 'products');
            
            onValue(productsRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    products = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key]
                    }));
                    processAdminProductsData();
                } else {
                    products = [];
                    updateAdminUI();
                }
            }, (error) => {
                console.error("Error fetching products:", error);
                showMessage('Error loading products: ' + error.message, 'error');
            });
        }

        // Fetch products from JSON file (fallback)
        function fetchProductsJSON() {
            if (CONFIG.DATA_BACKEND !== "json") return;
            
            fetch('products.json')
                .then(response => response.json())
                .then(data => {
                    products = data;
                    processAdminProductsData();
                })
                .catch(error => {
                    console.error("Error fetching products from JSON:", error);
                    showMessage('Error loading products: ' + error.message, 'error');
                });
        }

        // Process products data for admin
        function processAdminProductsData() {
            // Extract unique categories
            categories = [...new Set(products.map(product => product.category))].filter(Boolean);
            
            // Update categories datalist
            updateCategoriesDatalist();
            
            // Update admin UI
            updateAdminUI();
        }

        // Update categories datalist
        function updateCategoriesDatalist() {
            const categoriesList = document.getElementById('categories-list');
            const editCategoriesList = document.getElementById('edit-categories-list');
            
            categoriesList.innerHTML = '';
            editCategoriesList.innerHTML = '';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                categoriesList.appendChild(option);
                
                const editOption = document.createElement('option');
                editOption.value = category;
                editCategoriesList.appendChild(editOption);
            });
        }

        // Update admin UI with product data
        function updateAdminUI() {
            // Update stats
            document.getElementById('total-products').textContent = products.length;
            document.getElementById('total-categories').textContent = categories.length;
            
            // Update recent products
            updateRecentProducts();
            
            // Update edit products list
            updateEditProductsList();
        }

        // Update recent products in dashboard
        function updateRecentProducts() {
            const recentProductsList = document.getElementById('recent-products-list');
            const recentProducts = products.slice(-5).reverse(); // Last 5 products, newest first
            
            if (recentProducts.length === 0) {
                recentProductsList.innerHTML = '<p>No products yet. Add your first product!</p>';
                return;
            }
            
            recentProductsList.innerHTML = '';
            recentProducts.forEach(product => {
                const productItem = document.createElement('div');
                productItem.className = 'product-item';
                productItem.innerHTML = `
                    <div class="product-item-image">
                        <img src="${product.images && product.images.length > 0 ? product.images[0] : 'https://via.placeholder.com/60x60?text=No+Image'}" 
                             alt="${product.title}">
                    </div>
                    <div class="product-item-info">
                        <h4>${product.title}</h4>
                        <p>$${product.price || '0.00'} • ${product.category || 'Uncategorized'}</p>
                    </div>
                    <div class="product-item-actions">
                        <button class="btn btn-small" data-id="${product.id}" data-action="edit">Edit</button>
                    </div>
                `;
                recentProductsList.appendChild(productItem);
            });
            
            // Add event listeners to edit buttons
            document.querySelectorAll('#recent-products-list [data-action="edit"]').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    openEditModal(productId);
                });
            });
        }

        // Update edit products list
        function updateEditProductsList() {
            const editProductsList = document.getElementById('edit-products-list');
            
            if (products.length === 0) {
                editProductsList.innerHTML = '<p>No products found. Add your first product!</p>';
                return;
            }
            
            editProductsList.innerHTML = '';
            products.forEach(product => {
                const productItem = document.createElement('div');
                productItem.className = 'product-item';
                productItem.innerHTML = `
                    <div class="product-item-image">
                        <img src="${product.images && product.images.length > 0 ? product.images[0] : 'https://via.placeholder.com/60x60?text=No+Image'}" 
                             alt="${product.title}">
                    </div>
                    <div class="product-item-info">
                        <h4>${product.title}</h4>
                        <p>$${product.price || '0.00'} • ${product.category || 'Uncategorized'}</p>
                        <p class="product-item-sku">SKU: ${product.sku || 'N/A'}</p>
                    </div>
                    <div class="product-item-actions">
                        <button class="btn btn-small" data-id="${product.id}" data-action="edit">Edit</button>
                        <button class="btn btn-small btn-danger" data-id="${product.id}" data-action="delete">Delete</button>
                    </div>
                `;
                editProductsList.appendChild(productItem);
            });
            
            // Add event listeners to action buttons
            document.querySelectorAll('#edit-products-list [data-action]').forEach(button => {
                button.addEventListener('click', function() {
                    const action = this.getAttribute('data-action');
                    const productId = this.getAttribute('data-id');
                    
                    if (action === 'edit') {
                        openEditModal(productId);
                    } else if (action === 'delete') {
                        deleteProduct(productId);
                    }
                });
            });
            
            // Add search functionality
            document.getElementById('edit-search').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const productItems = document.querySelectorAll('#edit-products-list .product-item');
                
                productItems.forEach(item => {
                    const title = item.querySelector('h4').textContent.toLowerCase();
                    const category = item.querySelector('p').textContent.toLowerCase();
                    const sku = item.querySelector('.product-item-sku').textContent.toLowerCase();
                    
                    if (title.includes(searchTerm) || category.includes(searchTerm) || sku.includes(searchTerm)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }

        // Open edit product modal
        function openEditModal(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // Populate form with product data
            document.getElementById('edit-product-id').value = product.id;
            document.getElementById('edit-product-title').value = product.title;
            document.getElementById('edit-product-short-desc').value = product.shortDescription || '';
            document.getElementById('edit-product-full-desc').value = product.description || '';
            document.getElementById('edit-product-price').value = product.price || '';
            document.getElementById('edit-product-category').value = product.category || '';
            document.getElementById('edit-product-sku').value = product.sku || '';
            document.getElementById('edit-product-affiliate-link').value = product.affiliateLink || '';
            document.getElementById('edit-product-visibility').value = product.visibility || 'visible';
            
            // Display current images
            const currentImagesContainer = document.getElementById('current-images');
            currentImagesContainer.innerHTML = '';
            
            if (product.images && product.images.length > 0) {
                product.images.forEach((image, index) => {
                    const imageElement = document.createElement('div');
                    imageElement.className = 'current-image';
                    imageElement.innerHTML = `
                        <img src="${image}" alt="Product Image ${index + 1}">
                        <button type="button" class="remove-image" data-index="${index}">&times;</button>
                    `;
                    currentImagesContainer.appendChild(imageElement);
                });
                
                // Add event listeners to remove image buttons
                document.querySelectorAll('.remove-image').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        removeProductImage(productId, index);
                    });
                });
            } else {
                currentImagesContainer.innerHTML = '<p>No images</p>';
            }
            
            // Clear new image preview
            document.getElementById('edit-image-preview').innerHTML = '';
            document.getElementById('edit-product-images').value = '';
            
            // Show modal
            document.getElementById('edit-modal').style.display = 'block';
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        // Add new product
        async function adminAddProduct(productData, images) {
            if (CONFIG.DATA_BACKEND === 'firebase') {
                // Add to Firebase
                const productsRef = ref(db, 'products');
                const newProductRef = push(productsRef);
                
                // Upload images if any
                let imageUrls = [];
                if (images && images.length > 0) {
                    imageUrls = await uploadImagesToStorage(images, newProductRef.key);
                }
                
                // Prepare product data
                const productToSave = {
                    ...productData,
                    images: imageUrls,
                    createdAt: new Date().toISOString()
                };
                
                // Save to Firebase
                try {
                    await set(newProductRef, productToSave);
                    showMessage('Product added successfully!', 'success');
                    document.getElementById('add-product-form').reset();
                    document.getElementById('image-preview').innerHTML = '';
                    return true;
                } catch (error) {
                    console.error('Error adding product:', error);
                    showMessage('Error adding product: ' + error.message, 'error');
                    return false;
                }
            } else {
                // JSON backend - would need server API for this
                showMessage('JSON backend requires server API for write operations', 'error');
                return false;
            }
        }

        // Update existing product
        async function adminEditProduct(productId, productData, newImages) {
            if (CONFIG.DATA_BACKEND === 'firebase') {
                const productRef = ref(db, `products/${productId}`);
                
                // Upload new images if any
                let newImageUrls = [];
                if (newImages && newImages.length > 0) {
                    newImageUrls = await uploadImagesToStorage(newImages, productId);
                }
                
                // Get current product to preserve existing images
                const currentProduct = products.find(p => p.id === productId);
                const currentImages = currentProduct.images || [];
                
                // Prepare update data
                const updateData = {
                    ...productData,
                    images: [...currentImages, ...newImageUrls],
                    updatedAt: new Date().toISOString()
                };
                
                // Update in Firebase
                try {
                    await update(productRef, updateData);
                    showMessage('Product updated successfully!', 'success', 'edit-product-message');
                    closeEditModal();
                    return true;
                } catch (error) {
                    console.error('Error updating product:', error);
                    showMessage('Error updating product: ' + error.message, 'error', 'edit-product-message');
                    return false;
                }
            } else {
                // JSON backend - would need server API for this
                showMessage('JSON backend requires server API for write operations', 'error', 'edit-product-message');
                return false;
            }
        }

        // Delete product
        async function adminDeleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                return;
            }
            
            if (CONFIG.DATA_BACKEND === 'firebase') {
                const productRef = ref(db, `products/${productId}`);
                
                try {
                    await remove(productRef);
                    showMessage('Product deleted successfully!', 'success');
                    closeEditModal();
                } catch (error) {
                    console.error('Error deleting product:', error);
                    showMessage('Error deleting product: ' + error.message, 'error');
                }
            } else {
                // JSON backend - would need server API for this
                showMessage('JSON backend requires server API for write operations', 'error');
            }
        }

        // Remove product image
        async function removeProductImage(productId, imageIndex) {
            if (CONFIG.DATA_BACKEND === 'firebase') {
                const product = products.find(p => p.id === productId);
                if (!product || !product.images || !product.images[imageIndex]) return;
                
                // Create new images array without the removed image
                const updatedImages = [...product.images];
                updatedImages.splice(imageIndex, 1);
                
                // Update product in Firebase
                const productRef = ref(db, `products/${productId}`);
                try {
                    await update(productRef, { images: updatedImages });
                    showMessage('Image removed successfully!', 'success', 'edit-product-message');
                    
                    // Refresh the modal
                    openEditModal(productId);
                } catch (error) {
                    console.error('Error removing image:', error);
                    showMessage('Error removing image: ' + error.message, 'error', 'edit-product-message');
                }
            } else {
                showMessage('JSON backend requires server API for write operations', 'error', 'edit-product-message');
            }
        }

        // Upload images to Firebase Storage
        async function uploadImagesToStorage(imageFiles, productId) {
            const imageUrls = [];
            
            for (let i = 0; i < imageFiles.length; i++) {
                const file = imageFiles[i];
                const imageRef = storageRef(storage, `products/${productId}/${Date.now()}_${file.name}`);
                
                try {
                    const snapshot = await uploadBytes(imageRef, file);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    imageUrls.push(downloadURL);
                } catch (error) {
                    console.error('Error uploading image:', error);
                    showMessage(`Error uploading image ${i + 1}: ${error.message}`, 'error');
                }
            }
            
            return imageUrls;
        }

        // Export products to JSON
        function adminExportJSON() {
            const dataStr = JSON.stringify(products, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'nextsoro-products.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showMessage('Products exported successfully!', 'success');
        }

        // Import products from JSON
        function adminImportJSON(file, importMode) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedProducts = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedProducts)) {
                        throw new Error('Invalid JSON format. Expected an array of products.');
                    }
                    
                    // Validate each product
                    for (let i = 0; i < importedProducts.length; i++) {
                        const product = importedProducts[i];
                        if (!product.title || !product.price) {
                            throw new Error(`Product at index ${i} is missing required fields (title, price).`);
                        }
                    }
                    
                    if (CONFIG.DATA_BACKEND === 'firebase') {
                        // Import to Firebase
                        if (importMode === 'replace') {
                            // Replace all products
                            const productsRef = ref(db, 'products');
                            remove(productsRef).then(() => {
                                // Add imported products
                                const promises = importedProducts.map(product => {
                                    const newProductRef = push(ref(db, 'products'));
                                    return set(newProductRef, {
                                        ...product,
                                        importedAt: new Date().toISOString()
                                    });
                                });
                                
                                Promise.all(promises)
                                    .then(() => {
                                        showMessage(`Successfully imported ${importedProducts.length} products!`, 'success', 'import-message');
                                    })
                                    .catch(error => {
                                        console.error('Error importing products:', error);
                                        showMessage('Error importing products: ' + error.message, 'error', 'import-message');
                                    });
                            });
                        } else {
                            // Merge with existing
                            const promises = importedProducts.map(product => {
                                const newProductRef = push(ref(db, 'products'));
                                return set(newProductRef, {
                                    ...product,
                                    importedAt: new Date().toISOString()
                                });
                            });
                            
                            Promise.all(promises)
                                .then(() => {
                                    showMessage(`Successfully imported ${importedProducts.length} products!`, 'success', 'import-message');
                                })
                                .catch(error => {
                                    console.error('Error importing products:', error);
                                    showMessage('Error importing products: ' + error.message, 'error', 'import-message');
                                });
                        }
                    } else {
                        // JSON backend - would need server API for this
                        showMessage('JSON backend requires server API for write operations', 'error', 'import-message');
                    }
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    showMessage('Error parsing JSON file: ' + error.message, 'error', 'import-message');
                }
            };
            
            reader.readAsText(file);
        }

        // Switch data backend
        function switchDataBackend(backend) {
            if (backend !== 'firebase' && backend !== 'json') {
                console.error('Invalid backend specified. Use "firebase" or "json".');
                return;
            }
            
            CONFIG.DATA_BACKEND = backend;
            document.getElementById('data-backend').textContent = backend === 'firebase' ? 'Firebase' : 'JSON';
            
            // Reload products with new backend
            loadAdminData();
            
            showMessage(`Backend switched to ${backend}`, 'success');
        }

        // Show message to user
        function showMessage(message, type, elementId = null) {
            const messageElement = elementId ? 
                document.getElementById(elementId) : 
                document.getElementById('add-product-message');
                
            messageElement.textContent = message;
            messageElement.className = `form-message ${type}`;
            
            // Clear message after 5 seconds
            setTimeout(() => {
                messageElement.textContent = '';
                messageElement.className = 'form-message';
            }, 5000);
        }

        // Handle image preview
        function handleImagePreview(inputElement, previewElementId) {
            const previewElement = document.getElementById(previewElementId);
            previewElement.innerHTML = '';
            
            if (inputElement.files) {
                Array.from(inputElement.files).forEach(file => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'image-preview-item';
                        previewElement.appendChild(img);
                    };
                    
                    reader.readAsDataURL(file);
                });
            }
        }

        // Initialize the admin application
        function initAdmin() {
            initializeFirebase();
            
            // Set up event listeners
            document.getElementById('login-btn').addEventListener('click', function() {
                const password = document.getElementById('admin-password').value;
                adminLogin(password);
            });
            
            document.getElementById('admin-password').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    const password = this.value;
                    adminLogin(password);
                }
            });
            
            document.getElementById('logout-btn').addEventListener('click', function() {
                isLoggedIn = false;
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('admin-panel').style.display = 'none';
                document.getElementById('admin-password').value = '';
            });
            
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Skip logout button
                    if (this.id === 'logout-btn') return;
                    
                    // Update active nav link
                    document.querySelectorAll('.nav-link').forEach(item => {
                        item.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Show corresponding section
                    const sectionId = this.getAttribute('data-section');
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    document.getElementById(sectionId).classList.add('active');
                });
            });
            
            // Add product form
            document.getElementById('add-product-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const productData = {
                    title: document.getElementById('product-title').value,
                    shortDescription: document.getElementById('product-short-desc').value,
                    description: document.getElementById('product-full-desc').value,
                    price: parseFloat(document.getElementById('product-price').value),
                    category: document.getElementById('product-category').value,
                    sku: document.getElementById('product-sku').value,
                    affiliateLink: document.getElementById('product-affiliate-link').value,
                    visibility: document.getElementById('product-visibility').value
                };
                
                const imageFiles = document.getElementById('product-images').files;
                adminAddProduct(productData, imageFiles);
            });
            
            // Edit product form
            document.getElementById('edit-product-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const productId = document.getElementById('edit-product-id').value;
                const productData = {
                    title: document.getElementById('edit-product-title').value,
                    shortDescription: document.getElementById('edit-product-short-desc').value,
                    description: document.getElementById('edit-product-full-desc').value,
                    price: parseFloat(document.getElementById('edit-product-price').value),
                    category: document.getElementById('edit-product-category').value,
                    sku: document.getElementById('edit-product-sku').value,
                    affiliateLink: document.getElementById('edit-product-affiliate-link').value,
                    visibility: document.getElementById('edit-product-visibility').value
                };
                
                const newImageFiles = document.getElementById('edit-product-images').files;
                adminEditProduct(productId, productData, newImageFiles);
            });
            
            // Delete product button
            document.getElementById('delete-product-btn').addEventListener('click', function() {
                const productId = document.getElementById('edit-product-id').value;
                adminDeleteProduct(productId);
            });
            
            // Close modal
            document.querySelector('.close-modal').addEventListener('click', closeEditModal);
            
            // Close modal when clicking outside
            document.getElementById('edit-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEditModal();
                }
            });
            
            // Image preview for add product
            document.getElementById('product-images').addEventListener('change', function() {
                handleImagePreview(this, 'image-preview');
            });
            
            // Image preview for edit product
            document.getElementById('edit-product-images').addEventListener('change', function() {
                handleImagePreview(this, 'edit-image-preview');
            });
            
            // Export products
            document.getElementById('export-btn').addEventListener('click', adminExportJSON);
            
            // Import products
            document.getElementById('import-file').addEventListener('change', function() {
                document.getElementById('import-btn').disabled = !this.files.length;
            });
            
            document.getElementById('import-btn').addEventListener('click', function() {
                const file = document.getElementById('import-file').files[0];
                const importMode = document.querySelector('input[name="import-mode"]:checked').value;
                
                if (file) {
                    adminImportJSON(file, importMode);
                }
            });
            
            // Backend switch
            document.getElementById('data-backend-select').addEventListener('change', function() {
                switchDataBackend(this.value);
            });
            
            // Site settings form
            document.getElementById('site-settings-form').addEventListener('submit', function(e) {
                e.preventDefault();
                // In a real implementation, this would save to Firebase/config
                showMessage('Site settings saved!', 'success');
            });
            
            // Social links form
            document.getElementById('social-links-form').addEventListener('submit', function(e) {
                e.preventDefault();
                // In a real implementation, this would save to Firebase/config
                showMessage('Social links saved!', 'success');
            });
        }

        // Initialize the admin when DOM is loaded
        document.addEventListener('DOMContentLoaded', initAdmin);
    </script>
</body>
  </html>
